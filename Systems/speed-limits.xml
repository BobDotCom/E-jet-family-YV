<PropertyList>
    <!--
        Optimal AoA (alpha_opt): 0.26 RAD.
        Optimal cl (cl_opt): 1.40 * 0.8 * Sw-sqft
        Current cl: lift / qbar-psf
        Optimal lift (lift_opt): cl_opt * qbar-psf
        Optimal lift at vcrit = cl_opt * qbar-psf * vcrit^2 / v^2 = weight
        cl_opt * qbar-psf * vcrit^2 / v^2 = weight
        cl_opt * qbar-psf * vcrit^2 = weight * v^2
        vcrit^2 = weight * v^2 / (cl_opt * qbar-psf)
    -->
    <filter>
        <name>Optimal cl</name>
        <type>gain</type>
        <gain>1</gain>
        <input>
            <expression>
                <product>
                    <property>/fdm/jsbsim/metrics/Sw-sqft</property>
                    <sum>
                        <value>1.12</value>
                        <product>
                            <property>/fdm/jsbsim/fcs/slat-pos-norm</property>
                            <value> 0.25 </value>
                        </product>
                        <product>
                            <property>/fdm/jsbsim/fcs/flap-pos-norm</property>
                            <value> 0.75 </value>
                        </product>
                        <product>
                            <property>/fdm/jsbsim/fcs/speedbrake-pos-norm</property>
                            <value>-0.2</value>
                        </product>
                    </sum>
                </product>
            </expression>
        </input>
        <output>/fms/speed-limits/cl-opt</output>
    </filter>
    <filter>
        <name>Optimal lift</name>
        <type>gain</type>
        <gain>1</gain>
        <input>
            <expression>
                <product>
                    <property>/fms/speed-limits/cl-opt</property>
                    <property>/fdm/jsbsim/aero/qbar-psf</property>
                </product>
            </expression>
        </input>
        <output>/fms/speed-limits/lift-opt</output>
    </filter>
    <filter>
        <name>Vstall raw</name>
        <type>gain</type>
        <gain>1</gain>
        <input>
            <condition>
                <expression>
                    <greater-than>
                        <property>/fms/speed-limits/lift-opt</property>
                        <value>0.00001</value>
                    </greater-than>
                </expression>
            </condition>
            <expression>
                <!--
                  vcrit^2 = weight * v^2 / (cl_opt * qbar-psf)
                  vcrit = sqrt(weight * v^2 / lift_opt)
                  -->
                <sqrt>
                    <div>
                        <product>
                            <property>/fdm/jsbsim/inertia/weight-lbs</property>
                            <sqr><property>/instrumentation/airspeed-indicator/indicated-speed-kt</property></sqr>
                        </product>
                        <property>/fms/speed-limits/lift-opt</property>
                    </div>
                </sqrt>
            </expression>
        </input>
        <output>/fms/speed-limits/vstall-raw-kt</output>
    </filter>
    <filter>
        <name>Vstall 40 deg</name>
        <type>gain</type>
        <gain>1</gain>
        <input>
            <condition>
                <expression>
                    <greater-than>
                        <property>/fms/speed-limits/lift-opt</property>
                        <value>0.00001</value>
                    </greater-than>
                </expression>
            </condition>
            <expression>
                <!--
                  vcrit^2 = weight * v^2 / (cl_opt * qbar-psf)
                  vcrit = sqrt(weight * v^2 / lift_opt)
                  -->
                <sqrt>
                    <div>
                        <product>
                            <property>/fdm/jsbsim/inertia/weight-lbs</property>
                            <sqr><property>/instrumentation/airspeed-indicator/indicated-speed-kt</property></sqr>
                        </product>
                        <product>
                            <property>/fms/speed-limits/lift-opt</property>
                            <!-- cos 40° -->
                            <value>0.766044443118978</value>
                        </product>
                    </div>
                </sqrt>
            </expression>
        </input>
        <output>/fms/speed-limits/vstall-40-kt</output>
    </filter>
    <filter>
        <name>Green Dot speed</name>
        <type>gain</type>
        <gain>1</gain>
        <input>
            <condition>
                <expression>
                    <greater-than>
                        <property>/fms/speed-limits/lift-opt</property>
                        <value>0.00001</value>
                    </greater-than>
                </expression>
            </condition>
            <expression>
                <!--
                  vcrit^2 = weight * v^2 / (cl_opt * qbar-psf)
                  vcrit = sqrt(weight * v^2 / lift_opt)
                  -->
                <sqrt>
                    <div>
                        <product>
                            <!-- 1.3g margin -->
                            <value>1.3</value>
                            <property>/fdm/jsbsim/inertia/weight-lbs</property>
                            <sqr><property>/instrumentation/airspeed-indicator/indicated-speed-kt</property></sqr>
                        </product>
                        <product>
                            <property>/fms/speed-limits/lift-opt</property>
                            <!-- cos 40° -->
                            <value>0.766044443118978</value>
                        </product>
                    </div>
                </sqrt>
            </expression>
        </input>
        <output>/fms/speed-limits/green-dot-kt</output>
    </filter>
    <filter>
        <name>Vstall</name>
        <type>gain</type>
        <gain>1</gain>
        <input>
            <condition>
                <expression>
                    <greater-than>
                        <property>/fms/speed-limits/lift-opt</property>
                        <value>0.00001</value>
                    </greater-than>
                </expression>
            </condition>
            <expression>
                <!--
                  vcrit^2 = weight * v^2 / (cl_opt * qbar-psf)
                  vcrit = sqrt(weight * v^2 / lift_opt)
                  -->
                <sqrt>
                    <div>
                        <product>
                            <property>/fdm/jsbsim/inertia/weight-lbs</property>
                            <sqr><property>/instrumentation/airspeed-indicator/indicated-speed-kt</property></sqr>
                        </product>
                        <product>
                            <property>/fms/speed-limits/lift-opt</property>
                            <cos>
                                <product>
                                    <property>/orientation/roll-deg</property>
                                    <!-- convert to radians -->
                                    <value>0.017453292519943295</value>
                                </product>
                            </cos>
                        </product>
                    </div>
                </sqrt>
            </expression>
        </input>
        <output>/fms/speed-limits/vstall-kt</output>
    </filter>
    <filter>
        <name>Vwarn</name>
        <type>gain</type>
        <gain>1.06</gain>
        <input>
            <property>/fms/speed-limits/vstall-kt</property>
        </input>
        <output>/fms/speed-limits/vwarn-kt</output>
    </filter>

    <filter>
        <name>Vfe</name>
        <type>gain</type>
        <gain>1.0</gain>
        <input>
            <!-- flaps 6 = flaps 35°/25°  -->
            <condition>
                <greater-than>
                    <property>/fdm/jsbsim/fcs/flap-pos-deg</property>
                    <value>21</value>
                </greater-than>
            </condition>
            <property>/fms/speed-limits/vfe6</property>
        </input>
        <input>
            <!-- flaps 4/5 = 20°/25° -->
            <condition>
                <greater-than>
                    <property>/fdm/jsbsim/fcs/slat-pos-deg</property>
                    <value>16</value>
                </greater-than>
            </condition>
            <property>/fms/speed-limits/vfe4</property>
        </input>
        <input>
            <!-- flaps 3 = 20°/15° -->
            <condition>
                <greater-than>
                    <property>/fdm/jsbsim/fcs/flap-pos-deg</property>
                    <value>11</value>
                </greater-than>
            </condition>
            <property>/fms/speed-limits/vfe3</property>
        </input>
        <input>
            <!-- flaps 2 = 10°/15° -->
            <condition>
                <greater-than>
                    <property>/fdm/jsbsim/fcs/flap-pos-deg</property>
                    <value>6</value>
                </greater-than>
            </condition>
            <property>/fms/speed-limits/vfe2</property>
        </input>
        <input>
            <!-- flaps 1 = 5°/15° -->
            <condition>
                <greater-than>
                    <property>/fdm/jsbsim/fcs/flap-pos-deg</property>
                    <value>1</value>
                </greater-than>
            </condition>
            <property>/fms/speed-limits/vfe1</property>
        </input>
        <input>
            <property>/fms/speed-limits/vmo</property>
        </input>
        <output>/fms/speed-limits/vfe-effective</output>
    </filter>
    <filter>
        <name>Vlo</name>
        <type>gain</type>
        <gain>1.0</gain>
        <input>
            <!-- landing gear fully extended -->
            <condition>
                <and>
                    <equals><property>/gear/gear[0]/position-norm</property><value>1</value></equals>
                    <equals><property>/gear/gear[1]/position-norm</property><value>1</value></equals>
                    <equals><property>/gear/gear[2]/position-norm</property><value>1</value></equals>
                </and>
            </condition>
            <property>/fms/speed-limits/vle</property>
        </input>
        <input>
            <!-- landing gear fully retracted -->
            <condition>
                <and>
                    <equals><property>/gear/gear[0]/position-norm</property><value>0</value></equals>
                    <equals><property>/gear/gear[1]/position-norm</property><value>0</value></equals>
                    <equals><property>/gear/gear[2]/position-norm</property><value>0</value></equals>
                </and>
            </condition>
            <property>/fms/speed-limits/vmo</property>
        </input>
        <input>
            <!-- landing gear retracting -->
            <condition>
                <not><property>/controls/gear/gear-down</property></not>
            </condition>
            <property>/fms/speed-limits/vlo-retraction</property>
        </input>
        <input>
            <!-- landing gear extending -->
            <condition>
                <property>/controls/gear/gear-down</property>
            </condition>
            <property>/fms/speed-limits/vlo-extension</property>
        </input>
        <output>/fms/speed-limits/vlo-effective</output>
    </filter>
    <filter>
        <name>Vmo-alt</name>
        <type>gain</type>
        <gain>1.0</gain>
        <input>
            <condition>
                <less-than>
                    <property>/instrumentation/altimeter/pressure-alt-ft</property>
                    <property>/fms/speed-limits/vmo-low-alt-limit</property>
                </less-than>
            </condition>
            <property>/fms/speed-limits/vmo-low-alt</property>
        </input>
        <input>
            <condition>
                <less-than>
                    <property>/instrumentation/altimeter/pressure-alt-ft</property>
                    <property>/fms/speed-limits/vmo-high-alt-limit</property>
                </less-than>
            </condition>
            <expression>
                <sum>
                    <property>/fms/speed-limits/vmo-low-alt</property>
                    <product>
                        <difference>
                            <property>/instrumentation/altimeter/pressure-alt-ft</property>
                            <property>/fms/speed-limits/vmo-low-alt-limit</property>
                        </difference>
                        <div>
                            <difference>
                                <property>/fms/speed-limits/vmo</property>
                                <property>/fms/speed-limits/vmo-low-alt</property>
                            </difference>
                            <difference>
                                <property>/fms/speed-limits/vmo-high-alt-limit</property>
                                <property>/fms/speed-limits/vmo-low-alt-limit</property>
                            </difference>
                        </div>
                    </product>
                </sum>
            </expression>
        </input>
        <input>
            <property>/fms/speed-limits/vmo</property>
        </input>
        <output>/fms/speed-limits/vmo-alt-effective</output>
    </filter>
    <filter>
        <name>Vmo-Mmo</name>
        <type>gain</type>
        <gain>1.0</gain>
        <input>
            <condition>
                <greater-than>
                    <property>/velocities/mach</property>
                    <value>0.1</value>
                </greater-than>
            </condition>
            <expression>
                <product>
                    <property>/fms/speed-limits/mmo</property>
                    <div>
                        <property>/velocities/airspeed-kt</property>
                        <property>/velocities/mach</property>
                    </div>
                </product>
            </expression>
        </input>
        <input>
            <property>/fms/speed-limits/vmo</property>
        </input>
        <output>/fms/speed-limits/vmo-mmo</output>
    </filter>
    <filter>
        <name>Vmax</name>
        <type>gain</type>
        <gain>1.0</gain>
        <input>
            <expression>
                <min>
                    <property>/fms/speed-limits/vmo</property>
                    <property>/fms/speed-limits/vfe-effective</property>
                    <property>/fms/speed-limits/vlo-effective</property>
                    <property>/fms/speed-limits/vmo-alt-effective</property>
                    <property>/fms/speed-limits/vmo-mmo</property>
                </min>
            </expression>
        </input>
        <output>/fms/speed-limits/vmo-effective</output>
    </filter>

</PropertyList>
